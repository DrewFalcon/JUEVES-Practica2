=== INICIO DEBUG ===
Parámetros recibidos:
from: 'UUA    '
to: 'SVO    '
max_rows: 7
Parámetros después de trim:
from: 'UUA'
to: 'SVO'
date: '2017-07-31'
Tamaño de search.sql: 3068 bytes
Consulta SQL leída:

WITH RECURSIVE flight_paths AS (
    
    SELECT 
        f.flight_id, f.departure_airport, f.arrival_airport, f.scheduled_departure, f.scheduled_arrival,
        ARRAY[f.flight_id] AS flight_chain, (f.scheduled_arrival - f.scheduled_departure) AS total_duration, 0 AS connection_count,
        -- Calcular asientos libres para vuelo directo
        (SELECT COUNT(*) FROM seats s WHERE s.aircraft_code = f.aircraft_code) 
        - 
        (SELECT COUNT(*) FROM boarding_passes bp WHERE bp.flight_id = f.flight_id) AS free_seats
    FROM flights f
    WHERE f.departure_airport = ?
    AND f.arrival_airport = ?
    AND DATE(f.scheduled_departure) = ?  -- Filtro por fecha
    AND (f.scheduled_arrival - f.scheduled_departure) < INTERVAL '24 hours'
     -- Filtrar vuelos con asientos disponibles
      AND ((SELECT COUNT(*) FROM seats s WHERE s.aircraft_code = f.aircraft_code) 
           - 
           (SELECT COUNT(*) FROM boarding_passes bp WHERE bp.flight_id = f.flight_id)) > 0
    
    
    UNION ALL
    
    
    SELECT 
        f2.flight_id,
        fp.departure_airport AS original_departure,
        f2.arrival_airport,
        fp.scheduled_departure AS original_departure_time,
        f2.scheduled_arrival,
        fp.flight_chain || f2.flight_id,
        (f2.scheduled_arrival - fp.scheduled_departure) AS total_duration,
        fp.connection_count + 1,
        -- Tomar el MÍNIMO de asientos libres entre los vuelos
        LEAST(
            fp.free_seats,
            (SELECT COUNT(*) FROM seats s WHERE s.aircraft_code = f2.aircraft_code) 
            - 
            (SELECT COUNT(*) FROM boarding_passes bp WHERE bp.flight_id = f2.flight_id)
        ) AS free_seats
    FROM flight_paths fp
    JOIN flights f1 ON f1.flight_id = fp.flight_chain[array_length(fp.flight_chain, 1)]
    JOIN ticket_flights tf1 ON tf1.flight_id = f1.flight_id
    JOIN tickets t ON t.ticket_no = tf1.ticket_no
    JOIN ticket_flights tf2 ON tf2.ticket_no = t.ticket_no
    JOIN flights f2 ON f2.flight_id = tf2.flight_id
    WHERE 
        f2.departure_airport = f1.arrival_airport
        AND f2.scheduled_departure >= f1.scheduled_arrival 
        AND f2.scheduled_departure <= (f1.scheduled_arrival + INTERVAL '24 hours') 
        AND f2.flight_id <> ALL(fp.flight_chain)
        AND (f2.scheduled_arrival - fp.scheduled_departure) < INTERVAL '24 hours'
        AND fp.connection_count < 1
        -- Filtrar que el segundo vuelo tenga asientos disponibles
        AND ((SELECT COUNT(*) FROM seats s WHERE s.aircraft_code = f2.aircraft_code) 
             - 
             (SELECT COUNT(*) FROM boarding_passes bp WHERE bp.flight_id = f2.flight_id)) > 0
)
SELECT DISTINCT
    fp.flight_chain,
    fp.departure_airport AS original_departure,
    fp.arrival_airport AS final_arrival,
    fp.scheduled_departure AS original_departure_time,
    fp.scheduled_arrival AS final_arrival_time,
    fp.total_duration,
    fp.connection_count,
    fp.free_seats AS min_free_seats

FROM flight_paths fp
WHERE fp.free_seats > 0
ORDER BY fp.total_duration, fp.free_seats DESC;
Conexión ODBC exitosa
Parámetros bindeados: from='UUA', to='SVO'
Consulta ejecutada exitosamente
Fila 0: {23585}      | UUA -> SVO | 2017-07-31 10:35:00 | 2017-07-31 12:00:00 | 01:25:00     | 0   | 37 
Total de filas obtenidas: 1
=== FIN DEBUG ===
