=== INICIO DEBUG BPASS ===
Parámetros recibidos:
bookID: 'dada   '
max_rows: 18
Parámetros después de trim:
bookID: 'dada'
Tamaño de bpass.sql: 2155 bytes
Consulta SQL leída:
--BEGIN TRANSACTION;

WITH tickets_sin_boarding AS (
    SELECT 
        t.ticket_no,
        t.passenger_name,
        tf.flight_id,
        f.scheduled_departure,
        f.aircraft_code
    FROM tickets t
    JOIN ticket_flights tf ON t.ticket_no = tf.ticket_no
    JOIN flights f ON tf.flight_id = f.flight_id
    WHERE t.book_ref = ?
      AND NOT EXISTS (
          SELECT 1 
          FROM boarding_passes bp 
          WHERE bp.ticket_no = t.ticket_no 
            AND bp.flight_id = tf.flight_id
      )
),
asientos_disponibles AS (
    SELECT 
        tsb.ticket_no,
        tsb.flight_id,
        tsb.aircraft_code,
        (SELECT s.seat_no
         FROM seats s
         WHERE s.aircraft_code = tsb.aircraft_code
           AND NOT EXISTS (
               SELECT 1 
               FROM boarding_passes bp
               WHERE bp.flight_id = tsb.flight_id
                 AND bp.seat_no = s.seat_no
           )
         ORDER BY s.seat_no
         LIMIT 1) AS seat_no_disponible
    FROM tickets_sin_boarding tsb
),
-- Insertar boarding passes y obtener los datos insertados
inserted_passes AS (
    INSERT INTO boarding_passes (ticket_no, flight_id, boarding_no, seat_no)
    SELECT 
        tsb.ticket_no,
        tsb.flight_id,
        COALESCE((
            SELECT MAX(bp2.boarding_no) 
            FROM boarding_passes bp2 
            WHERE bp2.flight_id = tsb.flight_id
        ), 0) + ROW_NUMBER() OVER (PARTITION BY tsb.flight_id ORDER BY tsb.ticket_no),
        ad.seat_no_disponible
    FROM tickets_sin_boarding tsb
    JOIN asientos_disponibles ad ON tsb.ticket_no = ad.ticket_no 
        AND tsb.flight_id = ad.flight_id
    WHERE ad.seat_no_disponible IS NOT NULL
    RETURNING ticket_no, flight_id, seat_no
)
-- Seleccionar los datos para mostrar
SELECT 
    tsb.ticket_no,
    tsb.passenger_name,
    tsb.flight_id,
    tsb.scheduled_departure,
    tsb.aircraft_code,
    ad.seat_no_disponible
FROM tickets_sin_boarding tsb
JOIN asientos_disponibles ad ON tsb.ticket_no = ad.ticket_no 
    AND tsb.flight_id = ad.flight_id
WHERE ad.seat_no_disponible IS NOT NULL
ORDER BY tsb.ticket_no, tsb.flight_id;

--COMMIT TRANSACTION;
Conexión ODBC exitosa
Parámetro bindeado: bookID='dada'
Consulta ejecutada exitosamente
Total de filas obtenidas: 0
=== FIN DEBUG BPASS ===
